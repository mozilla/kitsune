FROM python:2-stretch

WORKDIR /app
EXPOSE 8000

COPY docker/bin/entrypoint.sh /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]

ENV LANG=C.UTF-8
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

RUN useradd  -d /app -M --uid 1000 --shell /usr/sbin/nologin kitsune

# Node is used in the staticfiles dockerfile but since this base image
# is used for development get it installed here too.
RUN apt-get update && apt-get install apt-transport-https && \
    echo "deb https://deb.nodesource.com/node_0.10 jessie main" >> /etc/apt/sources.list && \
    curl -s https://deb.nodesource.com/gpgkey/nodesource.gpg.key | apt-key add - && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
            gettext build-essential \
            libxml2-dev libxslt1-dev zlib1g-dev git \
            libjpeg-dev libffi-dev libssl-dev libxslt1.1 \
            libmariadbclient-dev mariadb-client && \
    rm -rf /var/lib/apt/lists/*

COPY ./requirements/ /app/requirements/

RUN bash -c '\
    virtualenv /venv && \
    source /venv/bin/activate && \
    pip install --no-cache-dir --require-hashes  -r requirements/default.txt && \
    pip install --no-cache-dir --require-hashes -r requirements/test.txt && \
    pip install --no-cache-dir --require-hashes -r requirements/dev.txt'

ARG GIT_SHA=head
ENV GIT_SHA ${GIT_SHA}
