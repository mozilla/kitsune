sudo: required
language: python
python: 2.7
services:
  - docker
before_install:
  - echo "ENV GIT_SHA ${TRAVIS_COMMIT}" >> Dockerfile
  - export GIT_SHA=${TRAVIS_COMMIT}
  - docker pull mozmeao/kitsune:latest
install:
  - pip install -U docker-compose
  - cp .env-travis .env
  - export UID
  - docker build -t mozmeao/kitsune:latest --cache-from mozmeao/kitsune .
  - docker-compose up -d mariadb
  - docker-compose up -d elasticsearch
  - docker-compose up -d redis
  - docker-compose up -d

  - docker-compose exec web ./manage.py nunjucks_precompile
  - docker-compose exec web ./manage.py compilejsi18n
  - docker-compose exec web ./manage.py collectstatic --noinput
script:
  - docker-compose exec web flake8 kitsune
  - docker-compose exec web sh -c "BABEL_DISABLE_CACHE=1 ./node_modules/.bin/mocha --compilers js:babel/register --recursive kitsune/*/static/*/js/tests/* $@"
  - docker-compose exec web sh -c "REUSE_STATIC=1 ./manage.py test --noinput --nologcapture -a '!search_tests' --with-nicedots"
notifications:
  email: false
  irc:
    channels:
    - irc.mozilla.org#sumodev
    on_success: always
    on_failure: always
