{% extends "kadmin/base.html" %}

{% block content_title %}
<h1>Elastic Search</h1>
{% endblock %}

{% block extrastyle %}
  {{ block.super }}
  <style type="text/css">
    div#content div {
      margin-bottom: .5em;
    }
    .disabled {
      color: #ccc;
    }
    progress {
      width: 400px;
    }
    dd {
      margin-left: 1em;
    }
  </style>
{% endblock %}

{% block footer %}
  {{ block.super }}
  <script type="text/javascript" src="{{ MEDIA_URL }}js/libs/jquery.min.js"></script>
  <script type="text/javascript">
    (function($) {
        // Quick and dirty AJAX progress bar. No error handling.
        function initProgressBar() {
            // Iff the progress bar is there, the reindex task is either
            // running or about to start.
            $("#reindex_progress").each(function() {
                var $bar = $(this);

                function setBar(ratio) {
                    $bar.attr("value", ratio);
                    $bar.text(ratio);
                }

                // We wait until the task starts and outputs a progress value.
                var started = false;

                // Spin around and actually update the progress bar.
                function spin(ratio) {
                    if (ratio === "" && started) {  // finished
                        document.location = '';  // Get rid of the bar and such.
                        return;
                    }
                    if (ratio !== "") {  // got data
                        started = true;
                        setBar(ratio);
                    }
                    $.get("{{ progress_url }}",  // Try again.
                          function ajaxSuccess(ratio) {
                              setTimeout(function() { spin(ratio); },
                                         {{ interval }});
                          });
                }

                spin("");
            });
        }

        $(document).ready(initProgressBar);

    })(jQuery);
  </script>
{% endblock %}

{% block content %}
  <section>
    {% if es_error_message %}
      <h1>Status</h1>
      <p>
        {{ es_error_message }}
      </p>
    {% else %}
      <h1>Settings</h1>
      <p>
        Settings at the time this page was loaded:
      </p>
      <table>
        <tr><th>ES_LIVE_INDEXING</th><td>{{ settings.ES_LIVE_INDEXING }}</td></tr>
        <tr><th>ES_INDEX_PREFIX</th><td>{{ settings.ES_INDEX_PREFIX }}</td></tr>
        <tr><th>ES_INDEXES</th><td>{{ settings.ES_INDEXES }}</td></tr>
        <tr><th>ES_WRITE_INDEXES</th><td>{{ settings.ES_WRITE_INDEXES }}</td></tr>
      </table>
      <h1>Status</h1>
      <p>
        All indexes available:
      </p>
      <table>
        <thead>
          <th>index name</th>
          <th>total documents in index</th>
          <th></th>
        </thead>
        <tbody>
          {% for index_name, index_count in indexes %}
            <tr>
              <td>{{ index_name }}</td><td>{{ index_count }}</td>
              {% if index_name == read_index %}
                <td>READ</td>
              {% else %}
                {% if index_name == write_index %}
                  <td>WRITE</td>
                {% else %}
                  <td></td>
                {% endif %}
              {% endif %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <p>
        Read index counts at time page was loaded ({{ read_index }}):
      </p>
      <table>
        <thead>
          <th>doctype</th>
          <th>count</th>
        </thead>
        <tbody>
          {% for stats_name, stats_count in doctype_stats.items %}
            <tr><td>{{ stats_name }}</td><td>{{ stats_count }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
      {% if read_index != write_index %}
        <p>
          Write index counts at time page was loaded ({{ write_index }}):
        </p>
        <table>
          <thead>
            <th>doctype</th>
            <th>count</th>
          </thead>
          <tbody>
            {% for stats_name, stats_count in doctype_write_stats.items %}
              <tr><td>{{ stats_name }}</td><td>{{ stats_count }}</td></tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p>
          Write index is the same as the read index.
        </p>
      {% endif %}
    {% endif %}

    <h1>Reindex</h1>
    <p>
      You should have to do this only when the search mapping changes or when
      setting up the site for the first time.
    </p>
    <p>
      If the old index isn't compatible with the new code, you should waffle Sphinx on first.
    </p>
    {% if read_index == write_index %}
      <p class="errornote">
        WARNING! Read and write indexes are the same! Reindexing would be really bad!
      </p>
    {% endif %}
    <form method="POST">
      {% csrf_token %}
      <div>
        <input type="submit"
               name="reindex"
               value="Reindex into {{ write_index }}"
               {% if progress %}disabled="disabled"{% endif %}/>
      </div>
      <div>
        <label>
          <input type="checkbox"
                 {% if waffle_when_done %}checked="checked"{% endif %}
                 value="1"
                 name="waffle_when_done"
                 {% if progress %}disabled="disabled"{% endif %} />
          <span{% if progress %} class="disabled"{% endif %}>
            Waffle Sphinx off when finished
          </span>
        </label>
      </div>
    </form>
    {% if progress %}
      <p>
        Reindexing into {{ write_index }} is currently in progress:
      </p>
      <progress id="reindex_progress" value="{{ progress }}" max="1">{{ progress }}</progress>
    {% endif %}
  </section>
{% endblock %}
