{# vim: set ts=2 et sts=2 sw=2: #}
{% extends "kbforums/base.html" %}
{# L10n: {d} is the name of the document. #}
{% set title = _('{l} Discussions | Knowledge Base')|f(l=locale_name) %}

{% block content %}
<article id="all-threads" class="main">
  <h1>{{ _('{l} Knowledge Base Discussions')|f(l=locale_name) }}</h1>
  <form id="watch_locale" action="{{ url('wiki.discuss.watch_locale') }}" method="post">
    {{ csrf() }}
    <input type="hidden" name="next" value="{{ request.get_full_path() }}">
    {% if is_watching_locale %}
      <input type="hidden" name="watch" value="no">
      <input type="submit" value="{{ _("Stop watching this locale") }}">
    {% else %}
      <input type="hidden" name="watch" value="yes">
      <input type="submit" value="{{ _("Watch this locale") }}">
    {% endif %}
  </form>
  <ol class="threads-columns {% if not desc_toggle %}desc{% endif %}">
    {% if user.is_authenticated() %}
      <li class="watch">{{ _('Watch') }}</li>
    {% endif %}
    <li class="title">{{ _('Title') }}</li>
    <li class="author{% if sort == 3 %} sort{% endif %}"><a href="{{ request.path|urlparams(sort=3, desc=desc_toggle) }}">{{ _('Author') }}</a></li>
    <li class="replies{% if sort == 4 %} sort{% endif %}"><a href="{{ request.path|urlparams(sort=4, desc=desc_toggle) }}">{{ _('Replies') }}</a></li>
    <li class="last-post{% if sort == 5 %} sort{% endif %}"><a href="{{ request.path|urlparams(sort=5, desc=desc_toggle) }}">{{ _('Last Post') }}</a></li>
  </ol>
  {% if threads.object_list %}
    <ol class="threads">
    {% for thread in threads.object_list %}
      <li>
        {% if user.is_authenticated() %}
          <div class="watch">
            <form class="watch-form" action="{{ url('wiki.discuss.watch_thread', thread.document.slug, thread.id) }}" method="post">
                {{ csrf() }}
                {% if thread.watches.filter(user=request.user) %}
                  {% set watch = _('Stop watching') %}
                  <input type="hidden" name="watch" value="no" />
                  <input type="image" alt="{{ watch }}" title="{{ watch }}" class="watchtoggle on" src="{{ MEDIA_URL }}img/forums/watch.png"/>
                {% else %}
                  {% set watch = _('Watch this thread') %}
                  <input type="hidden" name="watch" value="yes" />
                  <input type="image" alt="{{ watch }}" title="{{ watch }}" class="watchtoggle off" src="{{ MEDIA_URL }}img/forums/watch.png"/>
                {% endif %}
              </form>
          </div>
        {% endif %}
        <div class="title">
          {% trans thread_url=thread.get_absolute_url(),
                   thread_title=thread.title,
                   document_discussion_url=url('wiki.discuss.threads',thread.document.slug),
                   document=thread.document %}
            <a href="{{ thread_url }}">{{ thread_title }}</a><br>
            in <a href="{{ document_discussion_url }}">{{ document }}</a>
          {% endtrans %}
        </div>
        <div class="author"><a class="username" href="{{ profile_url(thread.creator) }}">{{ thread.creator.username }}</a></div>
        <div class="replies">{{ thread.replies }}</div>
        <div class="last-post">
          <a href="{{ thread.last_post.get_absolute_url() }}">
            {{ datetimeformat(thread.last_post.created) }}
          </a><br/>
          {{ _('by <a class="username" href="{profile_url}">{username}</a>')|fe(profile_url=profile_url(thread.last_post.creator), username=thread.last_post.creator.username) }}
        </div>
        <hr/>
      </li>
    {% endfor %}
    </ol>
    {{ threads|paginator }}
  {% else %}
    <p>{{ _('There are no threads. Maybe you should create some!') }}</p>
  {% endif %}
</article>
{% endblock %}
