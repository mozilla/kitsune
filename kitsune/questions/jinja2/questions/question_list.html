{% extends "questions/base.html" %}
{% from "dashboards/includes/macros.html" import topic_selector %}

{% set classes = 'questions' %}

{% if all_products %}
  {% set product_title = _('All Products') %}
{% elif multiple_products %}
  {% set product_title = _('Multiple Products') %}
{% else %}
  {% set product_title = pgettext('DB: products.Product.title', products[0].title) %}
  {% set logo = pgettext('DB: products.Product.image_alternate_url', products[0].image_alternate_url) %}
{% endif %}

{% set title = _('{product} Support Forum')|f(product=product_title) %}

{% set crumbs = [(url('questions.home'), _('Support Forum')), (None, product_title)] %}

{% set canonical_url = canonicalize(viewname='questions.list', product_slug=product_slug)|urlparams(None, request.GET) %}
{% if questions.number > 1 %}
  {% set canonical_url = canonical_url|urlparams(page=questions.number) %}
{% endif %}

{% set meta = (('robots', 'noindex'),) %}

{# This takes kwargs, even though it doesn't say so, because it uses them.
   It's a Jinja Magic thing. #}
{% macro questions_url() %}
  {{ url('questions.list', product_slug)|urlparams(None, request.GET, **kwargs) }}
{% endmacro %}

{% block breadcrumbs %}{% endblock %}

{% block masthead %}
<section class="sumo-page-section shade-bg">
  <div class="mzp-l-content">
    {{ breadcrumbs(crumbs, id='main-breadcrumbs') }}
  </div>
  <div class="mzp-l-content">
    <div class="sumo-l-two-col sidebar-on-right align-center">
      <div class="sumo-l-two-col--main">
        <h1 class="text-display-lg">
          <img class="page-heading--logo" src="{{ logo }}" alt="{{ title }} logo" />
          <span class="product-title-text">{{ title }}</span>
        </h1>
        <div id="recent-stats">
          <div class="no-reply">
            <p class="text-body-lg">
              {% if recent_unanswered_count > 0 %}
                {% trans recent_unanswered_count, url=questions_url(filter='recently-unanswered', show='all') %}
                  {{recent_unanswered_count}} question in the last 24 hours has no reply.
                  <a href="{{url}}">Help solve it!</a>
                  {% pluralize recent_unanswered_count %}
                  {{recent_unanswered_count}} questions in the last 24 hours> have no reply.
                  <a href="{{url}}">Help solve them!</a>
                {% endtrans %}
              {% else %}
                {% trans %}
                  0 questions in the last 24 hours have no reply. Good job!
                {% endtrans %}
              {% endif %}
            </p>
          </div>
        </div>
      </div>
      <div class="sumo-l-two-col--sidebar">
        <div id="top-contributors">
          {% set query_product = '?product={}'.format(products[0].slug) if products and products|length == 1 else '' %}
          <a class="sumo-button primary-button button-lg feature-box" href="{{ url('community.top_contributors', area='questions') }}{{ query_product }}">
            {{ _('Top Contributors') }}
          </a>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}





{% block content %}
{% if tags %}
  <div id="tagged">
    {{ _('Showing questions tagged:') }}
    <ul class="tag-list">
      {% for tag in tags -%}
      <li><a class="tag" href="{{ questions_url(tagged=tags_to_text (tags|remove(tag))) }}">{{ tag.name }}</a></li>
      {%- endfor %}
    </ul>
    <a class="show-all" href="{{ questions_url(tagged=None) }}">{{ _('Show all questions') }}</a>
  </div>
{% endif %}

<nav id="owner-tabs" class="tabs">
    <ul class="tabs--list subtopics">
      <li class="tabs--item">
        <a href="{{ questions_url(show='needs-attention', filter=None, page=None) }}" {{ show|class_selected('needs-attention') }}>
          <span>{{ _('Attention needed') }}</span>
        </a>
      </li>
      <li class="tabs--item">
        <a href="{{ questions_url(show='responded', filter=None, page=None) }}" {{ show|class_selected('responded') }}>
          <span>{{ _('Responded') }}</span>
        </a>
      </li>
      <li class="tabs--item">
        <a href="{{ questions_url(show='done', filter=None, page=None) }}" {{ show|class_selected('done') }}>
          <span>{{ _('Done') }}</span>
        </a>
      </li>
      <li class="tabs--item">
        <a href="{{ questions_url(show='all', filter=None, page=None) }}" {{ show|class_selected('all') }}>
          <span>{{ _('All questions') }}</span>
        </a>
      </li>
    </ul>
  </nav>
  <div id="filter-section"></div>

      <div id="questions-list">
        {% if questions.object_list %}
        <section class="forum--question-list questions">
          {% for question in questions.object_list %}
            <article id="question-{{ question.id }}" class="forum--question-item">
              <aside class="forum--meta question-meta {% if not question.num_answers %}urgent{% endif %}">
                {% set tags = question.my_tags %}
                <ul class="tag-list">
                {% if question.topic %}
                  {% set topic = question.topic %}
                  <li>
                    <a href="{{ url('questions.list', topic.product.slug)|urlparams(None, request.GET, topic=None) }}">
                      {{ pgettext('DB: products.Product.title', topic.product.title) }}
                    </a>
                  </li>
                {% endif %}
                {% for tag in tags %}
                  <li><a class="tag-name" href="{{ questions_url(tagged=tag.slug) }}">{{ tag }}</a></li>
                {% endfor %}
                </ul>

                <dl class="sumo-dl-inline forum--meta-dl replies">
                  <dt class="forum--meta-val">{{ question.num_answers }}</dt>
                  <dd class="forum--meta-key">{% trans count=question.num_answers %}reply{% pluralize %}replies{% endtrans %}</dd>
                  <dt class="forum--meta-val">{{ question.num_votes_past_week }}</dt>
                  <dd class="forum--meta-key">{{ _('votes this week') }}</dd>
                  {% if question.num_visits %}
                  <dt class="forum--meta-val">{{ question.num_visits }}</dt>
                  <dd class="forum--meta-key">{% trans count=question.num_visits %}view{% pluralize %}views{% endtrans %}</dd>
                  {% endif %}
                </dl>
              </aside>

              <ul class="topic-article--meta-list thread-meta">
                <li class="thread-solved {% if question.is_solved %}highlighted{% endif %}">
                  {{ _('Solved') }}
                </li>
                <li class="thread-contributed {% if question.is_contributor(user) %}highlighted{% endif %}">
                  {{ _('Contributed') }}
                </li>
                {% if question.is_locked %}
                  <li class="thread-locked highlighted">{{ _('Locked') }}</li>
                {% endif %}
                {% if question.is_archived %}
                  <li class="thread-archived highlighted">{{ _('Archived') }}</li>
                {% endif %}
              </ul>

              <div class="content ui-truncatable truncated">
                <h2 class="text-display-xxxs"><a href="{{ question.get_absolute_url() }}">{{ question.title }}</a></h2>

                {{ question.content_parsed|truncate_question(30, question.content_parsed)|safe }}


                <div class="forum--user-meta">
                  <div class="user-meta-asked-by">
                    {{ _('asked by <a href="{user_url}">{username}</a> {when}')|fe(user_url=profile_url(question.creator), username=display_name(question.creator), when=question.created|timesince) }}
                  </div>
                  {% if question.solution %}
                    <div class="user-meta-answered-by">
                      {{ _('answered by <a href="{user_url}">{username}</a> {when}')|fe(user_url=profile_url(question.solution.creator), username=display_name(question.solution.creator), when=question.solution.created|timesince) }}
                    </div>
                  {% else %}
                    {% if question.last_answer %}
                      <div class="user-meta-answered-by">
                        {{ _('<a href="{reply_url}">last reply</a> by <a href="{user_url}">{username}</a> {when}')|fe(reply_url=question.last_answer.get_absolute_url(), user_url=profile_url(question.last_answer.creator), username=display_name(question.last_answer.creator), when=question.last_answer.created|timesince) }}
                      </div>
                    {% endif %}
                  {% endif %}
                </div>
              </div>
            </article>
          {% endfor %}
        </section>

        {{ questions|quick_paginator }}

      {% else %}
        <p>{{ _('There are no questions that match the current filter settings.') }}</p>
      {% endif %}
    </div>
  </div>
{% endblock %}


{% block side %}

{% if topic_list %}
  {{ topic_selector(topic_list, topic) }}
{% endif %}


<div class="questions-sidebar">
  <nav class="sidebar-nav">
    <span class="details-heading"></span>
    <ul class="sidebar-nav--list">
      <li class="sidebar-subheading sidebar-nav--heading-item">{{ _('Filter by') }}</li>
      <li class="{% if filter == None and escalated == None %}selected{% endif %}"><a href="{{ questions_url(filter=None, escalated=None, page=None) }}">{{ _('All') }}</a></li>
      {% for f, desc in filters.iteritems() %}
      <li {{ filter|class_selected(f) }}><a href="{{ questions_url(filter=f, escalated=None, page=None) }}">{{ desc }}</a></li>
      {% endfor %}
      <li class="{% if filter == None and escalated %}selected{% endif %}"><a href="{{ questions_url(escalated=1, filter=None, page=None) }}">{{ _('Escalated') }}</a></li>

      <li class="sidebar-subheading sidebar-nav--heading-item">{{ _('Sort options') }}</li>
      {% for o, details in orders.iteritems() %}
        <li {{ order|class_selected(o) }}><a {% if order == o %}class="sort-{{ sort }}"{% endif %} href="{{ questions_url(order=o, sort=None if order != o else 'desc' if sort == 'asc' else 'asc', page=None) }}">{{ details[1] }}</a></li>
      {% endfor %}

      <li class="sidebar-subheading sidebar-nav--heading-item">{{ _('Show me') }}</li>
      <li {{ owner|class_selected(None) }}><a href="{{ questions_url(owner='all', page=None) }}">{{ _('Posts from everyone') }}</a></li>
      {% if request.user.is_authenticated() %}
      <li {{ owner|class_selected('mine') }}><a href="{{ questions_url(owner='mine', page=None) }}">{{ _('My contributions') }}</a></li>
      {% endif %}
    </ul>
  </nav>

  <div class="toggler">
    <span class="expand" data-toggle="collapsed" data-toggle-target="#questions-list" data-toggle-sticky="sticky"></span>
    <span class="collapse" data-toggle="collapsed" data-toggle-target="#questions-list" data-toggle-sticky="sticky"></span>
  </div>
</div>
{% endblock %}
