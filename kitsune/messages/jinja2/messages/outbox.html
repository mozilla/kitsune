{% extends "messages/base.html" %}
{% from "messages/includes/macros.html" import name_link %}
{% set title = _('Sent Messages') %}
{% set crumbs = [(url('messages.inbox'), _('Messages')),
                 (None, title)] %}
{% set active_tab = 'outbox' %}

{% block content %}
  <div class="sumo-page-section">
    <article id="outbox" class="main">
      <h1 class="sumo-page-heading">{{ title }}</h1>
        <div class="actions sumo-button-wrap">
          <a class="sumo-button primary-button" href="{{ url('messages.new') }}">{{ _('New Message') }}</a>
        </div>
      {% if msgs %}
        <form action="{{ url('messages.outbox_bulk_action') }}" method="POST">
          <div class="sumo-button-wrap">
            <button type="submit" name="delete" class="sumo-button">{{ _('Delete Selected') }}</button>
          </div>
          <ol class="message-list">
              <li class="message-list--item">
                <div class="field checkbox no-label">
                </div>
                <div class="avatar-details">
                  <span class="to user">
                    <b>{{ _('Sent') }}</b>
                  </span>
                  <span class="to user">
                    <b>{{ _('To') }}</b>
                  </span>                  
                  {% if in_staff_group(request.user) %}
                    <span class="to group">
                        <b>{{ _('To Groups') }}</b>
                    </span>
                  {% endif %}
                <span class="message-view">
                    <b>{{ _('Message') }}</b>
                </span>
                <span class="delete-button">
                </span>
                </div>
              </li>
            {% for message in msgs.object_list %}
              <li class="message-list--item">
                <div class="field checkbox no-label">
                  <input type="checkbox" name="id" value="{{ message.id }}" id="id_checkbox_{{ message.id }}">
                  <label for="id_checkbox_{{ message.id }}"></label>
                </div>
                <div class="avatar-details">
                  <span class="time">
                    <p>{{ datetimeformat(message.created) }}</p>
                  </span>
                  <span class="to user">
                    {% if message.recipients > 1 -%}
                      {% for user in message.to.all()[:3] -%}
                        <a rel="nofollow" href="{{ profile_url(user) }}">
                          {%- if name -%}
                            {{ name }}
                          {%- else -%}
                            {{ user.profile.display_name }}
                          {%- endif %}
                          {%- if not loop.last -%},{%- endif -%}
                        </a>
                      {% endfor %}
                      {% if message.recipients >= 3 -%}
                      ...
                      {% endif %}
                    {% else %}
                      {{ name_link(message.recipient) }}
                    {%- endif %}
                  </span>
                  {% if in_staff_group(request.user) %}
                    <span class="to group">
                      {% if message.to_groups %}
                        {% if message.to_groups_count > 0 -%}
                          {%- for group in message.to_group.all()[:3] -%}
                            {%- for profile in group.profile.all() -%}
                              {% set group_slug = profile.slug %}
                              <a href="{{ url('groups.profile', group_slug) }}">{{ group }}</a>
                            {%- endfor -%}
                            {%- if not loop.last -%},{%- endif -%}
                          {% endfor %}
                          {%- if message.to_groups_count > 3 -%}
                          ...
                          {% endif %}
                        {% else %}
                          {{ _('None') }}
                        {% endif %}
                      {% endif %}
                    </span>
                  {% endif %}
                <span class="message-view">
                  <a class="read message text-body-sm" href="{{ url('messages.read_outbox', message.id) }}">
                    {{ message.content_parsed|striptags|truncate(length=160) }}
                  </a>
                </span>
                <span class="delete-button">
                 <a class="delete" href="{{ url('messages.delete_outbox', message.id) }}" title="{{ _('Delete message') }}">&#x2716;</a>
                </span>
                </div>
              </li>
            {% endfor %}
          </ol>
          {% csrf_token %}
        </form>
        {{ msgs|paginator }}
      {% else %}
        <p>{{ _('There are no messages here.') }}</p>
      {% endif %}
    </article>
  </div>
{% endblock %}
